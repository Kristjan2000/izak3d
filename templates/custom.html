<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom 3D Order</title>
    <style>
        canvas {
            border: 1px solid black;
        }
    </style>
</head>
<body>
    <h1>Draw Your Idea</h1>

    <canvas id="canvas" width="400" height="400"></canvas>
    <br>
    <button onclick="undoLast()">Delete Last</button>
    <button onclick="clearCanvas()">Delete All</button>

    <div>
      
        <label for="description">description:</label><br>
        <textarea id="description" rows="4" cols="40"></textarea><br><br>

        <button onclick="saveData()">Submit</button>
    </div>

    <script>
        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");
        let drawing = false;
        let hasDrawn = false;

        canvas.addEventListener("mousedown", (e) => {
            if (e.button !== 0) return;
            drawing = true;
            hasDrawn = false
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            ctx.beginPath();
            ctx.moveTo(x, y);
        });
        canvas.addEventListener("mouseup", () => {
             if (drawing && hasDrawn) {
                saveState();
                hasDrawn = false;
             }
             drawing = false;
            ctx.beginPath();
        });
        canvas.addEventListener("mouseout", () => {
            drawing = false;
            ctx.beginPath();
        });
        canvas.addEventListener("mousemove", (e) => {
            if(drawing) draw(e);
        });
        const history = [];
        history.push(canvas.toDataURL());

        function draw(e) {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            ctx.lineWidth = 2;
            ctx.lineCap = "round";
            ctx.strokeStyle = "black";

            ctx.lineTo(x, y);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(x, y);

            hasDrawn = true;

        }

        function saveState() {
                history.push(canvas.toDataURL());
            }
        

        function undoLast() {
            if (history.length > 0) {
                history.pop();
                const previous = history[history.length -1];
                const img = new Image();
                img.onload = () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);
                }
                img.src = previous;
            }else {
                clearCanvas();
            }
        }
        function clearCanvas() {
            ctx.clearRect(0, 0 ,canvas.width, canvas.height);
            history.length = 0;
        }
                function saveData() {
                    const imageData = canvas.toDataURL();
                    const description = document.getElementById("description").value;

                    console.log({ imageData, width, height, description});
                    alert("Data collected (next step: send to server)");
                }
    </script>
</body>
</html>